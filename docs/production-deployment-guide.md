# æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ã‚¬ã‚¤ãƒ‰

## æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€Raspberry Piæœ¬ç•ªç’°å¢ƒã§ã®Family Album ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•ã‚’èª¬æ˜ã—ã¦ã„ã¾ã™ã€‚

## ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

```
nginx (port 80) 
â”œâ”€â”€ Frontend (Next.js) - port 3000
â””â”€â”€ Backend (FastAPI) - port 8000
```

- **nginx**: ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ï¼ˆå¤–éƒ¨ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’å„ã‚µãƒ¼ãƒ“ã‚¹ã«æŒ¯ã‚Šåˆ†ã‘ï¼‰
- **frontend**: Next.js ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
- **backend**: FastAPI ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
- **database**: MySQLï¼ˆãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ä¸Šã§ç¨¼åƒï¼‰

---

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

### 1. åŸºæœ¬ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰

**å…¨ã‚µãƒ¼ãƒ“ã‚¹ã®åˆå›èµ·å‹•/å…¨ä½“æ›´æ–°:**
```bash
cd /srv/family_album/api
docker compose up --build -d
```

### 2. å€‹åˆ¥ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤

#### ğŸ¨ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã¿æ›´æ–°
```bash
cd /srv/family_album/api
docker compose up --build -d frontend
```

**å®Ÿè¡Œå†…å®¹:**
- Dockerfile ã«åŸºã¥ã„ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒªãƒ“ãƒ«ãƒ‰
- `npm install` â†’ `npm run build` â†’ ã‚³ãƒ³ãƒ†ãƒŠå†èµ·å‹•
- ç´„1-2åˆ†ã§å®Œäº†

#### âš™ï¸ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã¿æ›´æ–°
```bash
cd /srv/family_album/api
docker compose up --build -d api
```

**å®Ÿè¡Œå†…å®¹:**
- Pythonä¾å­˜é–¢ä¿‚ã®å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°
- FastAPIã‚µãƒ¼ãƒãƒ¼ã®å†èµ·å‹•

#### ğŸŒ Nginxã®ã¿æ›´æ–°
```bash
cd /srv/family_album/api
docker compose up --build -d nginx
```

**å®Ÿè¡Œå†…å®¹:**
- nginxè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å†èª­ã¿è¾¼ã¿
- ãƒ—ãƒ­ã‚­ã‚·è¨­å®šã®åæ˜ 

---

## ğŸ“Š ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ã®ç¢ºèª

### ã‚³ãƒ³ãƒ†ãƒŠçŠ¶æ…‹ç¢ºèª
```bash
# å…¨ã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹
docker compose ps

# ç‰¹å®šã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹
docker compose ps frontend
docker compose ps api
docker compose ps nginx
```

### ãƒ­ã‚°ç¢ºèª
```bash
# å…¨ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ­ã‚°
docker compose logs

# ç‰¹å®šã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ­ã‚°
docker compose logs frontend
docker compose logs api
docker compose logs nginx

# ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°ç›£è¦–
docker compose logs -f frontend
```

### ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç¢ºèª
```bash
# Docker Composeã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çŠ¶æ³
docker compose ps

# ç›´æ¥ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç¢ºèª
curl http://localhost:80/api/health
curl http://localhost:3000/
```

---

## âš ï¸ é‡è¦: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­å®šã«ã¤ã„ã¦

### ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ã®ä»•çµ„ã¿

å†™çœŸã¨ã‚µãƒ ãƒã‚¤ãƒ«ã‚’USBãƒ‰ãƒ©ã‚¤ãƒ–ã«æ°¸ç¶šåŒ–ã™ã‚‹ã«ã¯ã€**ç’°å¢ƒå¤‰æ•°ã¨ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒã‚¦ãƒ³ãƒˆã®æ•´åˆæ€§**ãŒå¿…é ˆã§ã™ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­£ã—ã„è¨­å®š                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç’°å¢ƒå¤‰æ•°:  PHOTOS_STORAGE_PATH=/app/storage/photos              â”‚
â”‚ ãƒœãƒªãƒ¥ãƒ¼ãƒ : /media/usbdrive/.../photos:/app/storage/photos      â”‚
â”‚                        â†“                                        â”‚
â”‚ ã‚³ãƒ³ãƒ†ãƒŠå†… /app/storage/photos â†’ ãƒ›ã‚¹ãƒˆ /media/usbdrive/.../photos â”‚
â”‚ âœ… ãƒ‡ãƒ¼ã‚¿ã¯USBãƒ‰ãƒ©ã‚¤ãƒ–ã«æ°¸ç¶šåŒ–ã•ã‚Œã‚‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ é–“é•ã£ãŸè¨­å®šï¼ˆéå»ã®å•é¡Œï¼‰                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç’°å¢ƒå¤‰æ•°:  PHOTOS_STORAGE_PATH=/media/usbdrive/.../photos       â”‚
â”‚ ãƒœãƒªãƒ¥ãƒ¼ãƒ : /media/usbdrive/...:/app/storage/images             â”‚
â”‚                        â†“                                        â”‚
â”‚ ã‚³ãƒ³ãƒ†ãƒŠå†…ã« /media/usbdrive/.../photos ãŒè‡ªå‹•ä½œæˆã•ã‚Œã‚‹          â”‚
â”‚ âš ï¸ ã“ã®ãƒ‘ã‚¹ã¯ãƒã‚¦ãƒ³ãƒˆã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ã¯æ°¸ç¶šåŒ–ã•ã‚Œãªã„ï¼     â”‚
â”‚ ã‚³ãƒ³ãƒ†ãƒŠå†ä½œæˆæ™‚ã«ãƒ‡ãƒ¼ã‚¿æ¶ˆå¤±                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¨­å®šç¢ºèªã‚³ãƒãƒ³ãƒ‰

```bash
# 1. ç’°å¢ƒå¤‰æ•°ã¨ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®æ•´åˆæ€§ã‚’ç¢ºèª
./scripts/check-storage.sh

# 2. æ‰‹å‹•ç¢ºèª
docker compose exec api python -c "
from config.storage import storage_config
print('Photos:', storage_config.photos_path)
print('Thumbnails:', storage_config.thumbnails_path)
"

# 3. ãƒã‚¦ãƒ³ãƒˆãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹ã‹ãƒ†ã‚¹ãƒˆ
docker compose exec api sh -c 'echo test > /app/storage/photos/test.txt'
ls /media/usbdrive/family_album/photos/test.txt  # ãƒ›ã‚¹ãƒˆã§ç¢ºèª
rm /media/usbdrive/family_album/photos/test.txt  # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
```

---

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

#### 1. ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ãªã„
```bash
# ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ã—ã¦å†èµ·å‹•
docker compose down
docker compose up -d

# å¼·åˆ¶çš„ã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å†ãƒ“ãƒ«ãƒ‰
docker compose build --no-cache
docker compose up -d
```

#### 2. ãƒãƒ¼ãƒˆç«¶åˆã‚¨ãƒ©ãƒ¼
```bash
# ãƒãƒ¼ãƒˆä½¿ç”¨çŠ¶æ³ç¢ºèª
sudo netstat -tlnp | grep :80
sudo netstat -tlnp | grep :3000
sudo netstat -tlnp | grep :8000

# ç«¶åˆãƒ—ãƒ­ã‚»ã‚¹å¼·åˆ¶çµ‚äº†
sudo kill -9 <PID>
```

#### 3. å¤ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæ®‹ã£ã¦ã„ã‚‹
```bash
# æœªä½¿ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸å‰Šé™¤
docker image prune

# å…¨ã¦ã®åœæ­¢ã‚³ãƒ³ãƒ†ãƒŠã¨ã‚¤ãƒ¡ãƒ¼ã‚¸å‰Šé™¤ï¼ˆæ³¨æ„ï¼‰
docker system prune -a
```

#### 4. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼
```bash
# Node.jsã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å¾Œå†ãƒ“ãƒ«ãƒ‰
docker compose exec frontend npm cache clean --force
docker compose up --build -d frontend

# ã¾ãŸã¯æ‰‹å‹•ã§ã‚³ãƒ³ãƒ†ãƒŠå†…ç¢ºèª
docker compose exec frontend bash
cd /app && npm run build
```

#### 5. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIæ¥ç¶šã‚¨ãƒ©ãƒ¼
```bash
# APIã‚³ãƒ³ãƒ†ãƒŠå†…ã§ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
docker compose exec api curl http://localhost:8000/api/health

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª
docker compose exec api python -c "
from database import get_db
next(get_db())
print('DBæ¥ç¶šOK')
"
```

#### 6. ç”»åƒãŒè¡¨ç¤ºã•ã‚Œãªã„ / ã‚µãƒ ãƒã‚¤ãƒ«ãŒ404
```bash
# ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­å®šã®ç¢ºèª
./scripts/check-storage.sh

# DBã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã¨å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç…§åˆ
docker compose exec api python -c "
from database import SessionLocal
from models import Picture
from pathlib import Path
db = SessionLocal()
for pic in db.query(Picture).limit(3).all():
    path = Path('/app/storage') / pic.file_path
    print(f'{pic.file_path} -> exists: {path.exists()}')
db.close()
"

# ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã€ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒã‚¦ãƒ³ãƒˆè¨­å®šã‚’ç¢ºèª
# ã€Œé‡è¦: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­å®šã«ã¤ã„ã¦ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§
```

---

## ğŸ”„ å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### 1. ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
```bash
# nginxãƒ­ã‚°ã‚¯ãƒªã‚¢
sudo truncate -s 0 /srv/family_album/api/nginx/logs/*.log

# Dockerãƒ­ã‚°ã‚¯ãƒªã‚¢
docker compose down
sudo sh -c 'truncate -s 0 /var/lib/docker/containers/*/*-json.log'
docker compose up -d
```

### 2. ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ç¢ºèª
```bash
# ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ç¢ºèª
df -h

# Dockeré–¢é€£ã®ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡
docker system df
```

### 3. ã‚¤ãƒ¡ãƒ¼ã‚¸æ›´æ–°
```bash
# ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã®æ›´æ–°ç¢ºèª
docker compose pull
docker compose up --build -d
```

---

## ğŸ“ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œ
- [ ] ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://[RaspberryPI IP]/ ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- [ ] å†™çœŸä¸€è¦§ãƒšãƒ¼ã‚¸ã®ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‹•ä½œç¢ºèª
- [ ] ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‹•ä½œç¢ºèª
- [ ] å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ç¢ºèª

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œ
- [ ] API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ http://[RaspberryPI IP]/api/health å¿œç­”ç¢ºèª
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª
- [ ] å†™çœŸãƒ‡ãƒ¼ã‚¿å–å¾—APIå‹•ä½œç¢ºèª
- [ ] èªè¨¼æ©Ÿèƒ½å‹•ä½œç¢ºèª

### å…¨ä½“ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œ
- [ ] å…¨ã‚µãƒ¼ãƒ“ã‚¹ãŒ `healthy` çŠ¶æ…‹
- [ ] ãƒ­ã‚°ã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãªã„
- [ ] ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰/ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç¢ºèª
- [ ] è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã®å‹•ä½œç¢ºèª

---

## ğŸš¨ ç·Šæ€¥æ™‚å¯¾å¿œ

### ã‚µãƒ¼ãƒ“ã‚¹å…¨åœæ­¢
```bash
cd /srv/family_album/api
docker compose down
```

### å‰å›å‹•ä½œã—ã¦ã„ãŸçŠ¶æ…‹ã«æˆ»ã™
```bash
# æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆã‚’ç¢ºèª
git log --oneline -5

# ç‰¹å®šã®ã‚³ãƒŸãƒƒãƒˆã«æˆ»ã™
git checkout <commit-hash>
docker compose up --build -d

# å…ƒã«æˆ»ã™
git checkout main
```

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ã®å¾©æ—§
```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚‹å ´åˆ
mysql -u family_album_user -p family_album < backup.sql

# ç”»åƒãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚‹å ´åˆ
sudo rsync -av /backup/family_album/ /media/usbdrive/family_album/
```

---

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- **è¨­å®š**: `docker-compose.yml`
- **nginxè¨­å®š**: `nginx/nginx.conf`
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¨­å®š**: `frontend/.env.production`
- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­å®š**: `backend/config.py`
- **APIä»•æ§˜**: `docs/api-endpoints.md`

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆæƒ…å ±

**ãƒ­ã‚°åé›†æ–¹æ³•:**
```bash
# å…¨ä½“ãƒ­ã‚°åé›†
docker compose logs > deployment-logs.txt

# è©³ç´°ãªç’°å¢ƒæƒ…å ±
docker compose ps > container-status.txt
docker version >> container-status.txt
docker compose version >> container-status.txt
```

ã“ã‚Œã‚‰ã®æƒ…å ±ã‚’æ·»ä»˜ã—ã¦ã‚µãƒãƒ¼ãƒˆã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚