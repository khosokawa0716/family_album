# 家族のアルバム — 要件定義（v1）

> 本書は機能要件・非機能要件の合意用ドキュメントです。**データモデルやAPI設計は含みません。**

## 1. アプリ名
- 家族のアルバム

## 2. 目的
- 家族内で写真を安全に共有・閲覧・コメントできるようにする（自宅LAN内運用）

## 3. ユーザーロールと認証
- ロール：**管理者／一般ユーザー**
- **一般ユーザーもログイン必須**（匿名利用なし）
- 認証フロー（一般的な設計）
  - 管理者が**招待コード**を発行（または管理画面でユーザー作成）
  - ユーザーは **ユーザー名＋パスワード** で登録・ログイン（LAN運用のためメール検証は任意）
  - セッションはCookieで管理（CSRF対策、一定回数の失敗でクールダウン）
  - パスワードはハッシュ保存（管理者も閲覧不可）

## 4. 機能要件

### 4.1 写真の投稿【権限：一般ユーザー以上】
- 1回の投稿で**1枚**アップロード（将来、複数枚に拡張予定）
- 写真には**カテゴリ（単一選択）**を設定
  - カテゴリは管理者が**追加／削除／並び替え**可能
- 写真には**コメント**を追加可能（投稿者以外も可）
- 入力制限・仕様
  - 受け付け形式：**JPEG / PNG / GIF / WEBP / HEIC / HEIF**
  - HEIC/HEIFはバックエンドで**PNG に自動変換**
  - EXIF の**位置情報はデフォルトで削除**（向きは自動補正）
  - 1枚あたりの最大サイズ：**20MB**（設定で変更可）

### 4.2 写真の閲覧【権限：一般ユーザー以上】
- **一覧画面**（新着降順、**無限スクロール**）
- **絞り込み**：カテゴリ、年月（YYYY-MM）
- 写真をクリックすると**詳細**（大きめ表示、コメント一覧／追加）
- 原本画像の**ダウンロード可否**は設定で制御（デフォルト：可）

### 4.3 コメント【権限：一般ユーザー以上】
- 写真詳細でコメントの**投稿／閲覧**ができる
- **自分のコメントは自分で削除・編集**できる
- 荒らし対策：同一ユーザーの連投に**軽いレート制限**（数十秒間隔）

### 4.4 写真の削除【権限：管理者】
- 単一／複数の写真を削除できる
- **ごみ箱（ソフトデリート）**を採用
  - ごみ箱から**復元**可能
  - **30日後に自動で完全削除**（設定可能）

### 4.5 カテゴリ管理【権限：管理者】
- カテゴリの**追加／名称変更／削除／並び順変更**
- 既存写真に紐づくカテゴリを削除する場合は**置き換え先**の指定、または「未分類」に退避

## 5. 画面／ページ一覧
- 写真一覧：`/list`
- 写真詳細：`/detail/:id`
- 写真投稿：`/upload`（※`/register`から改名）
- 設定：`/settings`（容量・原本DL可否・EXIF設定の表示／一部は管理者のみ編集）
- 認証：`/login`（ログイン）, `/logout`（ログアウト）
- 管理者：`/admin`
  - ごみ箱管理、カテゴリ管理、ユーザー招待・管理 など

## 6. ネットワーク要件
- **Raspberry Pi 5** でホストし、**自宅Wi-Fi（LAN内）のみアクセス可能**
- ルーターで Pi の IP を**固定（DHCP予約）**
- mDNS で `album.local` のようなローカル名を配信
- 外部公開は前提にしない（将来は **VPN(Tailscale/WireGuard)** 等で限定開放を検討）

## 7. 画像保存・運用
- 画像の保存先は**外付けSSD**（例：`/mnt/photos`）に固定
- 原本・サムネイル（長辺1280px／一覧用320px）を**生成して保存**
- バックアップ方針（最低限）
  - 週1回、外付けHDD/NAS 等へ **rsync** でバックアップ（運用手順は別紙）
  - 残容量の**可視化**（`/settings`で表示）

## 8. 技術選定
- **Docker**：ローカル→本番（Raspberry Pi）への移行を容易に
- **Next.js**（フロントエンド）
- **Python**（バックエンド：画像変換・EXIF処理・API）
- **MySQL**（メタデータ管理）
- （必要に応じて）**Nginx** でリバースプロキシ

## 9. 非機能要件（抜粋）
- 体感性能：一覧は無限スクロール＋サムネ使用で**軽快**
- セキュリティ：**CSRF対策、認証試行のレート制限、管理操作の確認導線**
- ログ：管理者操作（削除・復元・カテゴリ変更など）は**操作ログ**を残す

## 10. 将来拡張（v1では未実装）
- **複数枚アップロード**（ドラッグ＆ドロップ）
- **タグ（複数付与）**／アルバム機能
- 外部からの限定閲覧（VPN）
- メール通知、モバイル端末からの自動アップロード連携
